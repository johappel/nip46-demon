<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JS Nostr Signer (No-Popup)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #121212; color: white; }
        #request-log {
            margin-top: 12px;
            padding: 10px;
            min-height: 80px;
            max-height: 180px;
            overflow: auto;
            background: #171717;
            border: 1px solid #333;
            border-radius: 8px;
            white-space: pre-wrap;
        }
        #auth-modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #222; padding: 20px; border: 1px solid #444; border-radius: 8px; z-index: 1000; max-width: 680px; width: 95%;
        }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        button { cursor: pointer; padding: 10px 14px; margin: 5px; border-radius: 5px; border: none; }
        .btn-approve { background: #28a745; color: white; }
        .btn-allow-temporary { background: #2f7cfe; color: white; }
        .btn-reject { background: #dc3545; color: white; }
        .button-row { display: flex; flex-wrap: wrap; margin-top: 10px; }
        #request-details { white-space: pre-wrap; max-height: 280px; overflow: auto; background: #171717; border: 1px solid #333; border-radius: 8px; padding: 10px; }
    </style>
</head>
<body>

    <h1>NIP-46 JS Signer</h1>
    <div id="status">Verbinde mit Relay...</div>
    <div id="user-info"></div>
    <pre id="request-log"></pre>

    <div id="overlay" class="overlay"></div>
    <div id="auth-modal">
        <h3 id="request-title">Signier-Anfrage</h3>
        <p id="request-details"></p>
        <div class="button-row">
            <button class="btn-approve" id="allow-once-btn">Einmal erlauben</button>
            <button class="btn-allow-temporary" id="allow-15m-btn">15m erlauben</button>
            <button class="btn-allow-temporary" id="allow-1h-btn">1h erlauben</button>
            <button class="btn-reject" id="reject-btn">Ablehnen</button>
        </div>
    </div>

    <script type="module">
        import NDK, { NDKNip46Backend, NDKPrivateKeySigner } from "https://esm.sh/@nostr-dev-kit/ndk@3.0.0";

        const NSEC_STORAGE_KEY = "nip46_demo_nsec";
        const PERMISSION_STORAGE_KEY = "nip46_permissions_v1";
        const RELAYS = ["wss://relay.damus.io", "wss://nos.lol"];
        const BRIDGE_SOURCE = "nip46-signer-bridge";
        const AUTO_ALLOW_METHODS = new Set(["connect", "ping", "get_public_key", "switch_relays"]);
        const SENSITIVE_METHODS = new Set([
            "sign_event",
            "nip04_encrypt",
            "nip04_decrypt",
            "nip44_encrypt",
            "nip44_decrypt"
        ]);

        const pendingPermissionRequests = [];
        let activePermissionRequest = null;
        let connectionInfo = null;

        function getOrAskNsec() {
            const stored = localStorage.getItem(NSEC_STORAGE_KEY);
            if (stored && stored.startsWith("nsec1") && stored.length > 20) return stored;

            const input = prompt("Bitte gib deinen nsec ein (nsec1...):", "");
            if (!input) throw new Error("Kein nsec angegeben.");

            const nsec = input.trim();
            if (!nsec.startsWith("nsec1") || nsec.length <= 20) {
                throw new Error("Ungültiger nsec. Erwartet wird ein kompletter nsec1...-Wert.");
            }

            localStorage.setItem(NSEC_STORAGE_KEY, nsec);
            return nsec;
        }

        function formatRequestParams(request) {
            const params = request?.params;
            if (!params) return "(keine)";

            try {
                if (request.method === "sign_event" && typeof params.rawEvent === "function") {
                    return JSON.stringify(params.rawEvent(), null, 2);
                }

                if (typeof params === "string") return params;
                return JSON.stringify(params, null, 2);
            } catch (_err) {
                return "[Parameter konnten nicht serialisiert werden]";
            }
        }

        function appendRequestLog(line) {
            const logEl = document.getElementById("request-log");
            const now = new Date().toLocaleTimeString();
            const previous = logEl.innerText ? `${logEl.innerText}\n` : "";
            const combined = `[${now}] ${line}\n${previous}`.split("\n").slice(0, 60).join("\n");
            logEl.innerText = combined.trimEnd();
        }

        function expectedParentOrigin() {
            const params = new URLSearchParams(window.location.search);
            const fromQuery = params.get("parentOrigin");
            if (fromQuery) return fromQuery;

            if (document.referrer) {
                try {
                    return new URL(document.referrer).origin;
                } catch (_err) {
                    return null;
                }
            }

            return null;
        }

        function postBridgeMessage(type, payload) {
            if (window.parent === window) return;

            const targetOrigin = expectedParentOrigin();
            if (!targetOrigin) {
                appendRequestLog(`Bridge blockiert: unbekannter parentOrigin (${type})`);
                return;
            }

            try {
                window.parent.postMessage(
                    { source: BRIDGE_SOURCE, type, payload },
                    targetOrigin
                );
            } catch (err) {
                appendRequestLog(`Bridge-Post fehlgeschlagen: ${err.message}`);
            }
        }

        function bridgeMessageHandler(event) {
            const targetOrigin = expectedParentOrigin();
            if (!targetOrigin || event.origin !== targetOrigin) return;

            const data = event.data;
            if (!data || data.source !== BRIDGE_SOURCE) return;

            if (data.type === "ping" || data.type === "get-connection-info") {
                postBridgeMessage("connection-info", connectionInfo);
            }
        }

        function loadPermissions() {
            try {
                const raw = localStorage.getItem(PERMISSION_STORAGE_KEY);
                return raw ? JSON.parse(raw) : {};
            } catch (_err) {
                return {};
            }
        }

        function savePermissions(permissions) {
            localStorage.setItem(PERMISSION_STORAGE_KEY, JSON.stringify(permissions));
        }

        function permissionKey(pubkey, method) {
            return `${pubkey}:${method}`;
        }

        function clearExpiredPermissions() {
            const now = Date.now();
            const permissions = loadPermissions();
            let changed = false;

            for (const [key, expiresAt] of Object.entries(permissions)) {
                if (typeof expiresAt !== "number" || expiresAt <= now) {
                    delete permissions[key];
                    changed = true;
                }
            }

            if (changed) savePermissions(permissions);
            return permissions;
        }

        function hasActivePermission(pubkey, method) {
            const permissions = clearExpiredPermissions();
            const key = permissionKey(pubkey, method);
            return typeof permissions[key] === "number" && permissions[key] > Date.now();
        }

        function grantPermission(pubkey, method, ttlMs) {
            const permissions = clearExpiredPermissions();
            permissions[permissionKey(pubkey, method)] = Date.now() + ttlMs;
            savePermissions(permissions);
        }

        function processPermissionQueue() {
            if (activePermissionRequest || pendingPermissionRequests.length === 0) return;

            activePermissionRequest = pendingPermissionRequests.shift();
            const { request, resolve } = activePermissionRequest;
            const method = request?.method;
            const pubkey = request?.pubkey;

            showModal(
                request,
                () => {
                    appendRequestLog(`Erlaubt (einmal): ${method}`);
                    resolve(true);
                    activePermissionRequest = null;
                    processPermissionQueue();
                },
                () => {
                    if (pubkey && method) {
                        grantPermission(pubkey, method, 15 * 60 * 1000);
                    }
                    appendRequestLog(`Erlaubt (15m): ${method}`);
                    resolve(true);
                    activePermissionRequest = null;
                    processPermissionQueue();
                },
                () => {
                    if (pubkey && method) {
                        grantPermission(pubkey, method, 60 * 60 * 1000);
                    }
                    appendRequestLog(`Erlaubt (1h): ${method}`);
                    resolve(true);
                    activePermissionRequest = null;
                    processPermissionQueue();
                },
                () => {
                    appendRequestLog(`Abgelehnt: ${method}`);
                    resolve(false);
                    activePermissionRequest = null;
                    processPermissionQueue();
                }
            );
        }

        function requestPermission(request) {
            return new Promise((resolve) => {
                pendingPermissionRequests.push({ request, resolve });
                processPermissionQueue();
            });
        }

        async function startSigner() {
            const ndk = new NDK({ explicitRelayUrls: RELAYS });
            await ndk.connect();

            const nsec = getOrAskNsec();
            const localSigner = new NDKPrivateKeySigner(nsec);
            const user = await localSigner.user();

            const relayQuery = RELAYS.map((relayUrl) => `relay=${encodeURIComponent(relayUrl)}`).join("&");
            const bunkerUri = `bunker://${user.pubkey}?${relayQuery}`;
            const nostrconnectUri = `nostrconnect://${user.pubkey}?${relayQuery}`;
            connectionInfo = {
                pubkey: user.pubkey,
                npub: user.npub,
                relays: RELAYS,
                bunkerUri,
                nostrconnectUri
            };

            document.getElementById("status").innerText = "Bereit für Anfragen";
            document.getElementById("user-info").innerText =
                `Aktiv als: ${user.npub.substring(0, 12)}...\n` +
                `Bunker URI: ${bunkerUri}\n` +
                `Nostrconnect URI: ${nostrconnectUri}`;

            const nip46Backend = new NDKNip46Backend(
                ndk,
                localSigner,
                async (request) => {
                    console.log("NIP-46 Anfrage:", request);
                    const method = request?.method;
                    const pubkey = request?.pubkey ?? "";
                    appendRequestLog(`Methode: ${method} von ${pubkey.slice(0, 12) || "?"}...`);

                    if (AUTO_ALLOW_METHODS.has(method)) {
                        appendRequestLog(`Auto erlaubt: ${method}`);
                        return true;
                    }

                    if (!SENSITIVE_METHODS.has(method)) {
                        appendRequestLog(`Nicht sensitiv, erlaubt: ${method}`);
                        return true;
                    }

                    if (pubkey && hasActivePermission(pubkey, method)) {
                        appendRequestLog(`TTL erlaubt: ${method}`);
                        return true;
                    }

                    return requestPermission(request);
                },
                RELAYS
            );

            await nip46Backend.start();
            postBridgeMessage("ready", connectionInfo);
            appendRequestLog("Bridge: ready an Parent gesendet");
            console.log("Bunker URI:", bunkerUri);
            console.log("Nostrconnect URI:", nostrconnectUri);
        }

        function showModal(req, onAllowOnce, onAllow15m, onAllow1h, onReject) {
            document.getElementById("request-title").innerText = `Anfrage: ${req.method}`;
            document.getElementById("request-details").innerText =
                `Methode: ${req.method}\nParameter: ${formatRequestParams(req)}`;

            document.getElementById("overlay").style.display = "block";
            document.getElementById("auth-modal").style.display = "block";

            document.getElementById("allow-once-btn").onclick = () => {
                hideModal();
                onAllowOnce();
            };

            document.getElementById("allow-15m-btn").onclick = () => {
                hideModal();
                onAllow15m();
            };

            document.getElementById("allow-1h-btn").onclick = () => {
                hideModal();
                onAllow1h();
            };

            document.getElementById("reject-btn").onclick = () => {
                hideModal();
                onReject();
            };
        }

        function hideModal() {
            document.getElementById("overlay").style.display = "none";
            document.getElementById("auth-modal").style.display = "none";
        }

        window.addEventListener("message", bridgeMessageHandler);

        startSigner().catch((err) => {
            console.error(err);
            document.getElementById("status").innerText = `Fehler: ${err.message}`;
        });
    </script>
</body>
</html>
